<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sign Up with Google + Metadata</title>
<style>
  body { font-family: Arial; display:flex; justify-content:center; align-items:center; height:100vh; background:#f0f0f0;}
  .container { background:#fff; padding:25px; border-radius:12px; width:400px; box-shadow:0 5px 20px rgba(0,0,0,0.1);}
  input, button { width:100%; padding:10px; margin:6px 0; border-radius:6px; border:1px solid #ccc; }
  button { background:#2575fc; color:#fff; border:none; cursor:pointer; }
  img.profile-pic { width:80px; height:80px; border-radius:50%; display:block; margin:10px auto; border:1px solid #ddd;}
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
<div class="container">
  <h3>Sign Up</h3>
  <form id="form-signup">
    <img id="avatar" class="profile-pic" src="" alt="Profile Picture">
    <input type="text" id="firstName" placeholder="First Name" required>
    <input type="text" id="lastName" placeholder="Last Name" required>
    <input type="tel" id="phone" placeholder="Phone Number" required>
    <input type="text" id="address" placeholder="Address" required>
    <input type="email" id="email" placeholder="Email" required>
    <button type="submit">Register</button>
  </form>

  <!-- Google Sign-In -->
  <div id="g_id_onload"
       data-client_id="YOUR_CLIENT_ID.apps.googleusercontent.com"
       data-context="signup"
       data-ux_mode="popup"
       data-callback="handleCredentialResponse"
       data-auto_select="true">
  </div>
  <div class="g_id_signin" data-type="standard" data-shape="rectangular" data-text="signup_with" data-size="large"></div>
</div>

<script>
  // Device info
  function getDeviceInfo() {
    return { userAgent: navigator.userAgent, platform: navigator.platform, language: navigator.language };
  }
  function getDateTime() { return new Date().toISOString(); }
  async function getUserIP() {
    try { const res = await fetch('https://api.ipify.org?format=json'); const data = await res.json(); return data.ip; } 
    catch(e){ return 'Unknown'; }
  }

  // Google Sign-In callback
  async function handleCredentialResponse(response){
    const payload = JSON.parse(atob(response.credential.split('.')[1]));
    console.log("Google User:", payload);

    // Autofill form
    document.getElementById('firstName').value = payload.name?.split(" ")[0] || "";
    document.getElementById('lastName').value = payload.name?.split(" ").slice(1).join(" ") || "";
    document.getElementById('email').value = payload.email || "";
    if(payload.picture){ document.getElementById('avatar').src = payload.picture; }
    window.googleUserTemp = payload;
  }
  window.handleCredentialResponse = handleCredentialResponse;

  // Form submit
  document.getElementById('form-signup').addEventListener('submit', async e=>{
    e.preventDefault();
    const firstName = document.getElementById('firstName').value.trim();
    const lastName = document.getElementById('lastName').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const email = document.getElementById('email').value.trim();
    const avatar = document.getElementById('avatar').src;

    const deviceInfo = getDeviceInfo();
    const dateTime = getDateTime();
    const ip = await getUserIP();
    const modalName = navigator.userAgentData?.brands?.map(b=>b.brand).join(",") || "Unknown";

    const payload = { firstName, lastName, phone, address, email, avatar, deviceInfo, ip, dateTime, modalName };
    console.log("Payload to save.servlet:", payload);

    fetch('/save.servlet', {
      method:'POST',
      headers:{ 'Content-Type':'application/json' },
      body: JSON.stringify(payload)
    })
    .then(res => res.text())
    .then(resp=>{ alert("Saved successfully!"); console.log(resp); })
    .catch(err=>{ alert("Error saving data"); console.error(err); });
  });
</script>
</body>
</html>
